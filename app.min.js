// ==UserScript==
// @name        threesbot
// @namespace   http://threesjs.com/
// @description threesbot
// @include     http://threesjs.com/
// @require     http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js
// @require     http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js
// @resource    jQueryUICSS http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css
// @version     1
// @grant       none
// ==/UserScript==
//var newCSS = GM_getResourceText ("jQueryUICSS");
//GM_addStyle (newCSS);
//this.$ = this.jQuery = jQuery.noConflict(true);
var MoveEvaluator=function(){var e={},t=function(e){var t=0,n=e[0];for(var r=e.length;--r>0;)e[r]>n&&(t=r,n=e[r]);return t},n=function(e,t){switch(e[t]){case-1:return!1;case 0:return e[t-1]!==0;case 1:return e[t-1]===2;case 2:return e[t-1]===1;default:return e[t-1]===e[t]}},r=function(e){for(var t=e.length;--t>0;)if(n(e,t))return!0;return!1},i=function(e){var t=e.length;while(--t>0)if(n(e,t)){e[t]+=e[t-1];break}if(t===0)return!1;while(--t>0)e[t]=e[t-1];return e[0]=0,!0},s=["up","down","left","right"];e.dirs=s;var o=4,u={up:!0,down:!0},a={up:!0,left:!0},f=function(e,t){var n=[];if(u[t])for(var r=0;r<o;++r){var i=[];for(var s=0;s<o;++s)i.push(e[s][r]);n.push(i)}else for(var r=o;--r>=0;)n.push(e[r].slice());if(a[t])for(var r=o;--r>=0;)n[r].reverse();return n};e.canApplyMove=function(e,t){var n=f(e,t);for(var i=n.length;--i>=0;)if(r(n[i]))return!0;return!1};var l=function(e,t){var n=f(e,t),r=[];for(var s=n.length;--s>=0;)i(n[s])&&r.push(s);return[n,r]},c=function(e){return s.map(function(t){return l(e,t)})},h=function(e){var t=0;for(var n=e.length;--n>=0;)for(var r=e[n].length;--r>=0;)e[n][r]===0&&++t;return t},p=function(e){switch(e){case-1:case 0:return 0;case 1:case 2:return-10;default:return e*e}},d=function(e){var t=0;for(var n=e.length;--n>=0;)for(var r=e[n].length;--r>=0;)t+=p(e[n][r]);return t},v=function(t,n,r){var i=n[0],s=n[1];if(s.length===0)return-1e5;if(t===0)return d(i);--t;var o=0;for(var u=s.length;--u>=0;)i[s[u]][0]=r,o+=e.evaluateMove(t,i,-1)[1],i[s[u]][0]=0;return o/s.length};return e.evaluateMove=function(e,n,r){var i=c(n),o=i.map(function(t){return 1+v(e,t,r)}),u=t(o);return[s[u],o[u]]},e},stringifyBoard=function(e){var t="[ ";for(var n=0;n<e.length;n++){var r="[ ";for(var i=0;i<e[n].length;i++)r+=e[n][i]+", ";r+=" ],\n",t+=r}return t},Controller=function(){var e={},t=MoveEvaluator(),n=null,r=0,i=200,s=!1,o=3;e.useNextTileList=!1;var u=function(){return{board:Session.get("tiles"),nextTile:Session.get("next_tile"),nextTileList:Session.get("current_deck")}},a={left:37,up:38,right:39,down:40},f=function(e){var t=jQuery.Event("keydown");return t.keyCode=t.which=a[e],$(window).trigger(t),e};return e.redrawBoard=function(){$(".board>.tile").remove(),document.THREE.display.render_board()},e.move=function(){r++;var n=u(),i=t.evaluateMove(o,n.board,n.nextTile)[0],a=t.canApplyMove(n.board,i);if(!a){var l=4;console.log(stringifyBoard(n.board));for(var c=0;c<4;c++){var h=t.canApplyMove(n.board,t.dirs[c]);h||l--,console.log(t.dirs[c]+" : "+h)}l===0&&e.stop()}return f(i),s&&e.redrawBoard(),i},e.play=function(){$("#playButton").attr("value","Stop").click(controller.stop),n===null&&(s?(console.log("playing choppy"),n=setInterval(e.move,i)):n=setInterval(function(){console.log("playing smooth"),$(".board>.tile").is(":animated")||e.move()},i))},e.stop=function(){r=0,e.redrawBoard(),$("#playButton").attr("value","Play").click(controller.play),n!==null&&(clearInterval(n),n=null)},e.setChoppy=function(t){e.stop(),s=t},e},drawUI=function(){controller=Controller();var e=$("<input type='button' id='playButton' value='Play'/>");e.click(controller.play),$("#new-game").after(e)};drawUI();